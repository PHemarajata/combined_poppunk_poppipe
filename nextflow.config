/*
 * nextflow.config â€“ Combined PopPUNK + PopPIPE Pipeline Configuration
 * Optimized for local execution with Docker containers
 */

process {
  executor      = 'local'
  cpus          = 8
  memory        = '32 GB'
  errorStrategy = 'retry'
  maxRetries    = 2
}

/* ---------  workflow-level parameters  --------- */
params {
  /* ===== INPUT/OUTPUT PATHS ===== */
  /* path to directory containing FASTA assemblies (.fasta) */
  input        = './input_genomes'

  /* where all results are written */
  resultsDir   = './results'

  /* ===== RESOURCE SETTINGS ===== */
  /* resource knobs used inside the pipeline - SEGFAULT PREVENTION */
  threads      = 8         // REDUCED: High thread counts cause segfaults in PopPUNK 2.7.5
  ram          = '32 GB'   // Memory allocation for PopPUNK processes

  /* ===== POPPUNK PHASE 1 PARAMETERS ===== */
  /* Mash settings for the pre-clustering step - OPTIMIZED FOR BETTER CLUSTERING */
  mash_k       = 21
  mash_s       = 1000
  mash_thresh  = 0.001     // 0.001 ~ 99.9% ANI (stringent for better separation)
  
  /* PopPUNK 2.7.x specific settings - OPTIMIZED FOR BETTER CLUSTERING */
  poppunk_stable       = false    // DISABLED: --stable core causes segfaults with large datasets
  poppunk_reciprocal   = true     // Use --reciprocal-only for better lineage fitting
  poppunk_max_search   = 20       // INCREASED: deeper search for better cluster boundaries
  poppunk_count_unique = true     // --count-unique-distances for better accuracy
  
  /* Additional PopPUNK model optimization */
  poppunk_model_dir    = 'poppunk_model'  // Model directory name
  poppunk_K            = 3        // Number of mixture components (try 2-4 for better separation)
  
  /* PopPUNK QC settings for poppunk_assign --run-qc */
  poppunk_max_zero_dist = 1       // --max-zero-dist: max zero distances allowed
  poppunk_max_merge     = 3       // --max-merge: max merge operations
  poppunk_length_sigma  = 2       // --length-sigma: outlying genome length detection
  poppunk_retain_failures = false // --retain-failures: keep failed QC samples in output

  /* ===== POPPIPE PHASE 2 PARAMETERS ===== */
  /* Minimum cluster size to subcluster */
  min_cluster_size = 6

  /* SKA options */
  ska_fastq_qual = 20
  ska_fastq_cov = 4
  ska_kmer = 31
  ska_single_strand = false
  ska_freq_filter = 0.85

  /* IQ-TREE options */
  iqtree_enabled = true
  iqtree_mode = 'full'  // 'full' or 'fast'
  iqtree_model = 'GTR+F+R6'  // +ASC recommended. May replace with GTR for single strand data

  /* fastbaps options */
  fastbaps_levels = 3  // Number of hierarchical clustering levels

  /* mandrake options */
  mandrake_knn = 50
  mandrake_perplexity = 25
  mandrake_maxIter = 100000

  /* Gubbins options */
  gubbins_prefix = 'gubbins'
  gubbins_tree_builder = 'iqtree'
  gubbins_min_snps = 3
  gubbins_min_window_size = 100
  gubbins_max_window_size = 10000
  gubbins_iterations = 5

  /* Microreact configuration (optional) */
  microreact_name = "Combined PopPUNK + PopPIPE Analysis"
  microreact_website = "none"
  microreact_email = "user@example.com"
  microreact_api_token = ""  // Add your Microreact API token here

  /* Transmission analysis (optional) */
  transmission_metadata = ""  // Path to transmission metadata CSV file
  
  /* transphylo options */
  transphylo_w_shape = 10
  transphylo_w_scale = 0.1
  transphylo_mcmcIterations = 1000
  transphylo_startNeg = 0.1
  transphylo_startOff_r = 1
  transphylo_startOff_p = 0.5
  transphylo_startPi = 0.5
  transphylo_optiStart = 2
  transphylo_dateT = 0
}

/* -------------  container runtime -------------- */
docker {
  enabled    = true        // run every process in its declared Docker image
  runOptions = '--user $(id -u):$(id -g)'  // run as current user
}

singularity {
  enabled = false   // ensure Singularity isn't used
}

/* -------------  reporting / visualisation ------ */
report {
  enabled = true
  file = "${params.resultsDir}/reports/execution_report.html"
}

timeline {
  enabled = true
  file = "${params.resultsDir}/reports/timeline.html"
}

dag {
  enabled = true
  file = "${params.resultsDir}/reports/pipeline_dag.html"
}

trace {
  enabled = true
  file = "${params.resultsDir}/reports/trace.txt"
}

/* -------------  process-specific settings ------ */
process {
  
  withName: 'VALIDATE_FASTA' {
    container = 'python:3.9'
    cpus = 4
    memory = '8 GB'
  }
  
  withName: 'MASH_SKETCH' {
    container = 'quay.io/biocontainers/mash:2.3--hb105d93_9'
    cpus = { params.threads }
    memory = { params.ram }
  }
  
  withName: 'MASH_DIST' {
    container = 'quay.io/biocontainers/mash:2.3--hb105d93_9'
    cpus = { Math.min(params.threads, 16) }
    memory = '64 GB'
  }
  
  withName: 'BIN_SUBSAMPLE' {
    container = 'python:3.9'
    cpus = 4
    memory = '16 GB'
  }
  
  withName: 'POPPUNK_MODEL' {
    container = 'staphb/poppunk:2.7.5'
    cpus = { params.threads }
    memory = { params.ram }
  }
  
  withName: 'POPPUNK_ASSIGN' {
    container = 'staphb/poppunk:2.7.5'
    cpus = { Math.min(params.threads, 16) }
    memory = { params.ram }
  }
  
  withName: 'SUMMARY_REPORT' {
    container = 'python:3.9'
    cpus = 2
    memory = '4 GB'
  }
  
  withName: 'SPLIT_STRAINS' {
    container = 'python:3.9'
    cpus = 2
    memory = '4 GB'
  }
  
  withName: 'SKETCHLIB_DISTS' {
    container = 'poppunk/poppipe:latest'
    cpus = 4
    memory = '16 GB'
  }
  
  withName: 'GENERATE_NJ' {
    container = 'poppunk/poppipe:latest'
    cpus = 2
    memory = '8 GB'
  }
  
  withName: 'SKA_BUILD' {
    container = 'poppunk/poppipe:latest'
    cpus = 4
    memory = '16 GB'
  }
  
  withName: 'SKA_ALIGN' {
    container = 'poppunk/poppipe:latest'
    cpus = 2
    memory = '8 GB'
  }
  
  withName: 'SKA_MAP' {
    container = 'poppunk/poppipe:latest'
    cpus = 2
    memory = '8 GB'
  }
  
  withName: 'IQ_TREE' {
    container = 'poppunk/poppipe:latest'
    cpus = 4
    memory = '16 GB'
  }
  
  withName: 'GUBBINS' {
    container = 'poppunk/poppipe:latest'
    cpus = 2
    memory = '8 GB'
  }
  
  withName: 'FASTBAPS' {
    container = 'poppunk/poppipe:latest'
    cpus = 4
    memory = '16 GB'
  }
  
  withName: 'CLUSTER_SUMMARY' {
    container = 'python:3.9'
    cpus = 2
    memory = '4 GB'
  }
}

/* -------------  execution profiles -------------- */
includeConfig 'conf/profiles.config'
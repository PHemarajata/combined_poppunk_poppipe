/*
 * Test configuration specifically for debugging segmentation faults
 * Ultra-conservative settings for PopPUNK stability
 */

params {
    // Test data paths
    input = './test_data'
    resultsDir = './test_results_segfault'
    
    // Ultra-conservative resources for segfault debugging
    threads = 1          // Single thread to isolate issues
    ram = '8 GB'         // Conservative memory allocation
    
    // PopPUNK stability settings - most conservative possible
    poppunk_stable = false        // Never use --stable
    poppunk_reciprocal = false    // Disable reciprocal-only
    poppunk_count_unique = false  // Disable count-unique-distances
    poppunk_max_search = 5        // Minimal search depth
    poppunk_K = 2                 // Minimal mixture components
    
    // Very conservative QC settings
    poppunk_max_zero_dist = 5
    poppunk_max_merge = 5
    poppunk_length_sigma = 5
    poppunk_retain_failures = false
    
    // Faster parameters for testing
    mash_s = 50          // Minimal sketch size
    mash_thresh = 0.1    // Very permissive threshold
    min_cluster_size = 2
    fastbaps_levels = 1
    
    // Disable time-consuming steps
    iqtree_mode = 'fast'
    gubbins_iterations = 1
}

process {
    // Ultra-conservative resources for all processes
    cpus = 1
    memory = '4 GB'
    time = '2.h'
    
    // Error handling for debugging
    errorStrategy = 'terminate'  // Stop immediately on error for debugging
    
    withName: 'POPPUNK_MODEL' {
        cpus = 1
        memory = '8 GB'
        time = '4.h'
        // Additional debugging options
        containerOptions = '--shm-size=2g --ulimit memlock=-1:-1 --ulimit core=0'
    }
    
    withName: 'POPPUNK_ASSIGN' {
        cpus = 1
        memory = '8 GB'
        time = '4.h'
        // Additional debugging options
        containerOptions = '--shm-size=2g --ulimit memlock=-1:-1 --ulimit core=0'
    }
    
    withName: 'MASH_DIST' {
        cpus = 1
        memory = '4 GB'
        time = '2.h'
    }
    
    withName: 'MASH_SKETCH' {
        cpus = 1
        memory = '4 GB'
        time = '1.h'
    }
}

// Enhanced debugging
trace {
    enabled = true
    file = "${params.resultsDir}/reports/trace_segfault_debug.txt"
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem'
}